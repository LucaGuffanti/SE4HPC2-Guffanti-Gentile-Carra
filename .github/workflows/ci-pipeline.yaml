name: Continuous Integration and Deployment Workflow
run-name: Execute ci/cd workflow
on: [push]
jobs:
    build-project-local:
      name: Build Project
      runs-on: ubuntu-latest
      steps: 

        - name : Install dependencies
          run: |
            sudo apt update
            sudo apt install -y mpich

        - name: Checkout repository
          uses: actions/checkout@v2
          with:
            submodules: true 
        - name: Build Project
          run: chmod +x build.sh && ./build.sh

        - name : Upload Project artifact
          uses: actions/upload-artifact@v2
          with:
            name: project-build-directory
            path: build
            if-no-files-found: error
            retention-days: 1
    
    test-project-local:
      name: Test Project
      runs-on: ubuntu-latest
      needs: [build-project-local]
      steps:

        - name : Install dependencies
          run: |
            sudo apt update
            sudo apt install -y mpich

        - name : Download Project artifact
          uses: actions/download-artifact@v2
          with:
            name: project-build-directory
            path: build

        - name: Run all tests
          run: | 
            cd build && ls -la && ./test_multiplication 

    build-container:
        name: Build Container
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2
            with:
              submodules: true 

          - name: Install Singularity
            uses: eWaterCycle/setup-apptainer@v2
            with:
              apptainer-version: 1.3.2

          - name: Build Container Image
            run: | 
              cd container
              sudo singularity --version
              sudo singularity build --notest matrix.sif matrix_multiplication.def

          - name : Upload Container artifact
            uses: actions/upload-artifact@v2
            with:
              name: container-image
              path: container/matrix.sif
              if-no-files-found: error
              retention-days: 1
              compression-level: 0
    
    test-container:
      name: Test Container
      runs-on: ubuntu-latest
      needs: [build-container]
      steps:
        - name: Install Singularity
          uses: eWaterCycle/setup-apptainer@v2
          with:
            apptainer-version: 1.3.2

        - name: Download Container artifact
          uses: actions/download-artifact@v2
          with:
            name: container-image
            path: matrix.sif

        - name: Run all tests
          run: |
            sudo singularity test matrix.sif
      
    upload-artifact:
      name: Upload Artifact
      runs-on: ubuntu-latest
      needs: [test-container, test-project-local] # TODO: check if test-project-local is needed
      steps:
        - name: Login to Singularity Remote
          run: |
            ls
            cd container
            ls
            echo "${{ secrets.SINGULARITY_ACCESS_TOKEN }}" > singularity_token.txt
            /opt/singularity/bin/singularity remote login --tokenfile singularity_token.txt
            /opt/singularity/bin/singularity push -U matrix.sif library://lucaguffanti/se/matrix:latest
            cd ..
              
    deploy-on-galileo:
      name: Deploy on Galileo
      runs-on: ubuntu-latest
      needs: [upload-artifact]
      steps:
            
        - name: SSH into GALILEO
          run: |
            sshpass -p ${{ secrets.GALILEO_TOKEN }} ssh -o StrictHostKeyChecking=no -t a08trb59@login.g100.cineca.it '
                singularity pull library://lucaguffanti/se/matrix:latest
                singularity run matrix_latest.sif
                rm matrix_latest.sif
                exit
            '
